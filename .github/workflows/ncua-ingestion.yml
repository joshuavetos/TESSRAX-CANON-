name: NCUA Unclaimed Deposits Ingestion Pipeline

on:
  schedule:
    # Run every 30 days (aligned with deduplication window)
    - cron: '0 9 1,15 * *'  
  workflow_dispatch: # Manual trigger for testing
  
env:
  RAW_LANDING: raw/ncua/${{ github.run_id }}
  CANONICAL_LEDGER: 05_LOGS/ncua_canonical_ledger.csv
  NERF_CHANNEL: 05_LOGS/nerf-notices

jobs:
  ingest-ncua:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout TESSRAX-CANON
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r 02_PROTOCOLS/requirements.txt
          pip install requests beautifulsoup4 pandas lxml html5lib

      - name: Create directories
        run: |
          mkdir -p raw/ncua/${{ github.run_id }}
          mkdir -p ${{ env.NERF_CHANNEL }}

      - name: Fetch NCUA unclaimed deposits
        id: fetch
        env:
          NCUA_URL: "https://ncua.gov/support-services/conservatorships-liquidations/unclaimed-deposits"
        run: |
          python 02_PROTOCOLS/ncua_ingestion.py \
            --url ${{ env.NCUA_URL }} \
            --output-dir ${{ env.RAW_LANDING }}
          
          RAW_COUNT=$(python - << EOF
import pandas as pd
df = pd.read_html("${{ env.RAW_LANDING }}/unclaimed.html")[0]
print(len(df))
EOF
          )
          echo "raw_row_count=$RAW_COUNT" >> $GITHUB_OUTPUT

      - name: Normalize & validate
        run: |
          python 02_PROTOCOLS/ncua_normalization.py \
            --input ${{ env.RAW_LANDING }}/unclaimed.html \
            --output 05_LOGS/ncua_normalized_${{ github.run_id }}.csv

      - name: Commit results
        run: |
          git config user.name "TESSRAX Automation"
          git config user.email "automation@tessrax.com"
          git add raw/ncua/${{ github.run_id }} 05_LOGS/
          git commit -m "NCUA ingestion $(date '+%Y-%m-%d')" || echo "No changes"
          git push
