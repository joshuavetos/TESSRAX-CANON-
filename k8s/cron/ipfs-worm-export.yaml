apiVersion: batch/v1
kind: CronJob
metadata:
  name: tessrax-ipfs-worm
  namespace: tessrax
  labels:
    app: tessrax
    canon: WORM-EXPORT
spec:
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 10
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: tessrax-ipfs
        spec:
          restartPolicy: Never
          serviceAccountName: tessrax-sys01
          securityContext:
            fsGroup: 1000

          initContainers:
            - name: fetch-forensics
              image: yourorg/tessrax-base:latest
              command:
                - sh
                - -c
                - |
                  set -e
                  mkdir -p /export/bundle

                  redis-cli -h epistemicos-redis KEYS "blocklog:F9-C:*" \
                    | xargs -I {} redis-cli -h epistemicos-redis GET {} \
                    > /export/bundle/blocklogs.jsonl

                  redis-cli -h epistemicos-redis KEYS "df:*" \
                    | xargs -I {} redis-cli -h epistemicos-redis GET {} \
                    >> /export/bundle/blocklogs.jsonl

                  redis-cli -h epistemicos-redis XRANGE siem:events - + \
                    > /export/bundle/siem.jsonl
              volumeMounts:
                - name: export-volume
                  mountPath: /export

          containers:
            - name: ipfs-worm
              image: ipfs/kubo:latest
              command:
                - sh
                - -c
                - |
                  set -e
                  cd /export/bundle

                  sha256sum * > CONTENT_HASHES.txt

                  cat > MANIFEST.json <<EOF
                  {
                    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                    "canon": "004",
                    "export_type": "WORM_BLOCKLOGS",
                    "blocklog_entries": $(wc -l < blocklogs.jsonl),
                    "siem_events": $(wc -l < siem.jsonl)
                  }
                  EOF

                  CID=$(ipfs add -r -Q .)

                  ipfs name publish --key=tessrax-worm /ipfs/$CID

                  RECEIPT="{\"cid\":\"$CID\",\"ipns\":\"/ipns/tessrax-worm\",\"manifest\":\"MANIFEST.json\"}"
                  echo "$RECEIPT" > /export/receipt.json

                  redis-cli -h epistemicos-redis SET "worm:receipt:$CID" "$RECEIPT"
              volumeMounts:
                - name: export-volume
                  mountPath: /export
                - name: ipfs-repo
                  mountPath: /data/ipfs
              resources:
                requests:
                  cpu: "200m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"

          volumes:
            - name: export-volume
              emptyDir: {}

            - name: ipfs-repo
              persistentVolumeClaim:
                claimName: tessrax-ipfs-repo

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: tessrax-ipfs-repo
  namespace: tessrax
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
