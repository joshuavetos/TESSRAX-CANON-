apiVersion: batch/v1
kind: CronJob
metadata:
  name: tessrax-ipfs-worm
  namespace: tessrax
  labels:
    app: tessrax
    canon: WORM-EXPORT
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 10
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: tessrax-ipfs
        spec:
          restartPolicy: Never
          serviceAccountName: tessrax-sys01
          securityContext:
            fsGroup: 1000
          containers:
            - name: ipfs-worm
              image: ipfs/kubo:v0.26.0
              command:
                - sh
                - -c
                - |
                  set -e

                  echo "[1/6] Initializing IPFS repo"
                  ipfs init --profile=server || true

                  echo "[2/6] Starting IPFS daemon"
                  ipfs daemon --offline &
                  DAEMON_PID=$!

                  echo "[3/6] Waiting for daemon"
                  sleep 8

                  echo "[4/6] Exporting Redis forensic data"
                  mkdir -p /export/bundle

                  redis-cli -h epistemicos-redis KEYS "blocklog:F9-C:*" | \
                    xargs -I {} redis-cli -h epistemicos-redis GET {} \
                    > /export/bundle/blocklogs.jsonl

                  redis-cli -h epistemicos-redis KEYS "df:*" | \
                    xargs -I {} redis-cli -h epistemicos-redis GET {} \
                    >> /export/bundle/blocklogs.jsonl

                  redis-cli -h epistemicos-redis XRANGE siem:events - + \
                    > /export/bundle/siem.jsonl

                  echo "[5/6] Creating manifest"
                  sha256sum /export/bundle/* > /export/bundle/CONTENT_HASHES.txt

                  cat > /export/bundle/MANIFEST.json << EOF
                  {
                    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                    "canon": "004",
                    "export_type": "WORM_BLOCKLOGS",
                    "files": [
                      "blocklogs.jsonl",
                      "siem.jsonl",
                      "CONTENT_HASHES.txt"
                    ]
                  }
                  EOF

                  echo "[6/6] Pinning bundle to IPFS"
                  CID=$(ipfs add -r -Q /export/bundle)
                  echo "CID=$CID"

                  echo "{\"cid\":\"$CID\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" \
                    | redis-cli -h epistemicos-redis SET "worm:receipt:$CID" -

                  echo "WORM EXPORT COMPLETE: $CID"

                  kill $DAEMON_PID
              env:
                - name: REDIS_URL
                  value: "redis://epistemicos-redis:6379/0"
              volumeMounts:
                - name: export-volume
                  mountPath: /export
              resources:
                requests:
                  cpu: "200m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"
          volumes:
            - name: export-volume
              emptyDir: {}
